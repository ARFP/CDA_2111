<!DOCTYPE html>
<html lang="fr-FR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="CDA2111">
    <meta name="keywords" content="nutriscore, céréales, protéines">
    <meta name="description" content="Affichage de céréales venant d'une api.">
    <title>Céréales</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/vue@3"></script>
</head>
<body>
    <div id="app">
        <header>
            <h1>Cereals</h1>
            <form action="#">

                <fieldset>
                    <legend>
                        <Label for="rechercher">Rechercher</Label>
                    </legend>
                    <input @input="filterByName" type="search" placeholder="Nom du céréale" id="rechercher">
                </fieldset>

                <fieldset>
                    <legend>Filtrer</legend>
                    <fieldset class="nutriscore-container">
                        <legend>
                            Nutriscore
                        </legend>
                        <label for="a">A</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="a" value="a">

                        <label for="b">B</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="b" value="b">

                        <label for="c">C</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="c" value="c">

                        <label for="d">D</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="d" value="d">

                        <label for="e">E</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="e" value="e">
                        
                    </fieldset>

                    <fieldset>
                        <legend>Catégorie</legend>
                        <select @change="filterByCategory" list="categories" id="categories">
                            <option value="tous">Tous</option>
                            <option value="sans-sucre">Sans sucre</option>
                            <option value="sans-sel">Pauvre en sel</option>
                            <option value="boost">Boost</option>
                        </select>
                    </fieldset>
                </fieldset>
            </form>
        </header>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th class="text-left">NOM</th>
                    <th>CALORIES</th>
                    <th>PROTÉINES</th>
                    <th>SEL</th>
                    <th>FIBRES</th>
                    <th>GLUCIDES</th>
                    <th>SUCRE</th>
                    <th>POTASSIUM</th>
                    <th>VITAMINES</th>
                    <th>ÉVALUATION</th>
                    <th>NS</th>
                    <th>DEL</th>
                </tr>
            </thead>
            <tbody id="perfect-body">
                <tr v-for="cereal in filteredCereals" :key="cereal.id">
                    <td class="identifiant">{{ cereal.id }}</td>
                    <td class="text-left">{{ cereal.name }}</td>
                    <td>{{ cereal.calories }}</td>
                    <td>{{ cereal.protein }}</td>
                    <td>{{ cereal.sodium }}</td>
                    <td>{{ cereal.fiber }}</td>
                    <td>{{ cereal.carbo }}</td>
                    <td>{{ cereal.sugars }}</td>
                    <td>{{ cereal.potass }}</td>
                    <td>{{ cereal.vitamins }}</td>
                    <td>{{ cereal.rating }}</td>
                    <td :class="cereal.nutriScore">{{ cereal.nutriScore }}</td>
                    <td>
                        <button @click="removeCereal(cereal)">X</button>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td></td>
                    <td>{{ countElement }} éléments</td>
                    <td>Moyenne calories {{ avgCalories }}</td>
                </tr>
            </tfoot>

        </table>
    </div>







    <script>
    const vue = Vue.createApp({
        data() {
        return {
            cereals: null,
            filterName: '',
            filterNutri: [],
            filterCategory: "tous",
            countElement: 0,
            avgCalories: 0

        }
        },
        methods: {
            async initCereals(){
                this.cereals = null;
                const res = await fetch("https://arfp.github.io/tp/web/frontend/cereals/cereals.json");
                let jsonData = await res.json();
                this.cereals = jsonData.data;

                // Nettoyer les données
                this.cereals.forEach((cereal) => {
                    // Ajout du nutriscore
                    cereal.nutriScore = this.checkNutriScore(cereal)
                    // Supprimer les valeurs -1 qui représentent l 'absence de données
                    for(const property in cereal){
                        if (cereal[property] === -1)
                            cereal[property] = null;
                    }
                })
            },
            checkNutriScore(cereal) {
                let result;
                if(cereal.rating > 80){
                    result = "A";
                } else if (cereal.rating > 70) {
                    result = "B";
                } else if (cereal.rating > 55) {
                    result = "C";
                } else if (cereal.rating > 35) {
                    result = "D";
                } else {
                    result = "E";
                }
                return result;
            },
            removeCereal(cerealToBeDeleted){
                this.cereals = this.cereals.filter((cereal) => cereal.id != cerealToBeDeleted.id);
            },
            filterByName(){
                this.filterName = event.target.value;
            },
            filterByNutriScore(){
                const fieldset = event.target.parentNode
                const checked = fieldset.querySelectorAll('input[type=checkbox]:checked')
                let result = []
                
                checked.forEach((input) => result.push(input.value) ) 
                this.filterNutri = result;
            },
            filterByCategory(){
                console.log(event.target.value)
                this.filterCategory = event.target.value
            }
        },
        computed: {
            filteredCereals(){
                let result;

                // filtre sur le nom du céréale
                if(this.filterName.length > 0){
                    result = this.cereals.filter((cereal) => cereal.name.toLowerCase().includes(this.filterName.toLowerCase()))
                } else {
                    result = this.cereals
                }
                

                // Filtre sur le nutriscore des céréales
                if(this.filterNutri.length > 0) {
                    result = result.filter(cereal => this.filterNutri.includes(cereal.nutriScore.toLowerCase()))
                }


                // Filtre sur la catégorie des céréales
                switch (this.filterCategory) {
                    case "sans-sucre":
                        result = result.filter((cereal) => cereal.sugars < 1 && cereal.sugars != null)
                        break
                    case "sans-sel":
                        result = result.filter((cereal) => cereal.sodium < 50 && cereal.sodium != null)
                        break
                    case "boost":
                        result = result.filter((cereal) => cereal.vitamins >= 25 && cereal.fiber >= 10)
                        break
                    default:
                        break
                }
                
                
                if (result != null) {
                    // Compte du nombre de céréales
                    this.countElement = result.length

                    // Calcul de la moyenne des calories des céréales affichées
                    let tmpSumCalories = 0;
                    // Calcul de la somme des calories
                    result.forEach(cereal => {
                        tmpSumCalories += cereal.calories
                    })
                    // Calcul de la moyenne avec 2 chiffres après la virgule
                    this.avgCalories = Math.round(tmpSumCalories/this.countElement *100)/100
                }
                

                return result;
            }


        },
        mounted() {
            try{
                this.initCereals();
            } catch(err) {
                console.error(err)
            }
            console.log("Cereals prêts");
        }
    }).mount('#app')
    </script>
</body>
</html>